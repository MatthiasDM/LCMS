<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <script>

        </script>
        <script src="./JS/ckeditor/plugins/templates/templates/defaultLCMS.js"></script>
    
        
    </head>
    <body>


        <div id="editor-wrapper">
            <form id="form-note-id">
                <div class="row" id="metadata-note-id">
                    <div LCMS="note-metadata" id="note-metadata" style='width: 100%'>

                    </div>
                </div>
                <textarea name="editor-note-id" id="editor-note-id" rows="200" cols="60" style="padding:10px">
                note-content
                </textarea>
            </form>
        </div>
    </body>

    <script id="script-note-id">
        $(function () {

            $.fn.modal.Constructor.prototype.enforceFocus = function () {
                var $modalElement = this.$element;
                $(document).on('focusin.modal', function (e) {
                    var $parent = $(e.target.parentNode);
                    if ($modalElement[0] !== e.target
                            && !$modalElement.has(e.target).length
                            && $(e.target).parentsUntil('*[role="dialog"]').length === 0) {
                        $modalElement.focus();
                    }
                });
            };
            
            loadNote_note-short-id();
            console.log("loading note framework");
            

        });
        
        function loadNote_note-short-id() {

            $("#navbar-extra .cke_top").remove();
            CKEDITOR.config.templates_files = ['http://localhost:8080/LCMS/JS/ckeditor/plugins/templates/templates/defaultLCMS.js'];
            CKEDITOR.config.allowedContent = {
                script: true,
                $1: {
                    // This will set the default set of elements
                    elements: CKEDITOR.dtd,
                    attributes: true,
                    styles: true,
                    classes: true
                }
            };
            CKEDITOR.on('instanceReady', function (ev) {
                CKEDITOR.removeAllListeners();
                var editor = ev.editor;
                console.log(CKEDITOR.instances);
                console.log("Loaded editor-note-id");
                //catch ctrl+clicks on <a>'s in edit mode to open hrefs in new tab/window
                $("#cke_editor-note-id").css("padding", "10px");
                $(".cke_top").css("min-width", "650px");
                $(".cke_chrome").css("border", "0px");
                $("#navbar-extra").prepend($(".cke_top")); //add toolbar to header
                insert = CKEDITOR.getTemplate('note');
                $('iframe').contents().click(function (e) {
                    if (typeof e.target.href != 'undefined' && e.ctrlKey == true) {
                        window.open(e.target.href, 'new' + e.screenX);
                    }
                });
                $('iframe').contents().find('#testiframe').iFrameResize();
                loadTOC_note-short-id('#cke_editor-note-id');
                loadImages_note-short-id('#cke_editor-note-id');

            });          
            

            
            CKEDITOR.scriptLoader.load("./JS/dependencies/bootstrap.min.js", function (success)
            {
                console.log("bootstrap js loaded");
            });
            CKEDITOR.config.contentsCss = ['./JS/dependencies/bootstrap.min.css',"./CSS/jquery.jexcel.css"];

            CKEDITOR.scriptLoader.load("./JS/iframeresizer/iframeResizer.min.js", function (success)
            {
                console.log("iframeResizer js loaded");
              
            });
            CKEDITOR.scriptLoader.load("./JS/jquery.jexcel.js");
            
            CKEDITOR.config.height = '100%';
            CKEDITOR.config.autoGrow_minHeight = 250;
            CKEDITOR.config.autoGrow_onStartup = true;



            CKEDITOR.replace('editor-note-id', {
                filebrowserBrowseUrl: '/browser/browse.php',
                filebrowserUploadUrl: '?page=other/upload'
            });

        }

        function loadTOC_note-short-id(editor) {
            console.log("Loading TOC");
            var editorContents = $(editor).find("iframe");
            var editorHeaders = editorContents.contents().find("h1, h2, h3, h4, h5, h6");
            var level1 = 0;
            var level2 = 0;
            var level3 = 0;
            var level4 = 0;
            var level5 = 0;
            var level6 = 0;
            $("#toc-list").empty();
            var headerNumber = "";
            editorHeaders.each(function (index) {
                var currentHeader = this.tagName.substr(1, this.tagName.length);
                if (currentHeader === "1") {
                    level1++;
                    level2 = 0;
                    level3 = 0;
                    level4 = 0;
                    level5 = 0;
                    level6 = 0;
                }
                if (currentHeader === "2") {
                    level2++;
                    level3 = 0;
                    level4 = 0;
                    level5 = 0;
                    level6 = 0;
                }
                if (currentHeader === "3") {
                    level3++;
                    level4 = 0;
                    level5 = 0;
                    level6 = 0;
                }
                if (currentHeader === "4") {
                    level4++;
                    level5 = 0;
                    level6 = 0;
                }
                if (currentHeader === '5') {
                    level5++;
                    level6 = 0;
                }
                if (currentHeader === '6') {
                    level6++;
                }
                var uuid = uuidv4();
                $(this).attr("id", uuid);
                var heading = level1 + "." + level2 + "." + level3 + "." + level4 + "." + level5 + "." + level6;
                while (heading.slice(-1) === "0") {
                    heading = heading.substr(0, heading.length - 2);
                }
                heading += ".";
                $("#toc-list").append("<li class='list-group-item' anchor='#" + uuid + "'>" + heading + " " + $(this).text() + "</li>");
                this.innerHTML = "<span class='nosave'>" + heading + " </span>" + this.innerHTML;

                var previousHeader = this.tagName.substr(1, this.tagName.length);
            });
            loadAnchors_note-short-id(editorContents);
        }

        function loadAnchors_note-short-id(editorContents) {
            console.log("Loading anchors");
            $('#toc-list li').on('click', function (event) {
                var target = editorContents.contents().find(this.getAttribute('anchor'));
                //var target = $(this.getAttribute('anchor'));
                if (target.length) {
                    event.preventDefault();
                    $('html, body').stop().animate({
                        scrollTop: target.offset().top
                    }, 1000);
                }
            });
        }

        function loadImages_note-short-id(editor) {

            var images = $(editor).find("iframe").contents().find('[fileid]')

            images.each(function (index) {
                downloadToTemp_note-short-id($(this));

            });

        }

        function downloadToTemp_note-short-id(file) {
            var formData = new FormData();
            formData.append('action', 'FILE_DOWNLOADTEMP');
            formData.append('LCMS_session', $.cookie('LCMS_session'));
            formData.append('filename', file.attr("name"));
            var request = new XMLHttpRequest();
            request.onreadystatechange = function () {
                if (request.readyState == 4) {
                    var jsonData = JSON.parse(request.responseText);
                    var filePath = jsonData.filePath;
                    console.log("Changing filepath from " + file.attr("src") + " to " + filePath);
                    file.attr("src", filePath);

                }
            }
            request.open('POST', "./upload", /* async = */ false);
            request.send(formData);
        }
    </script>

</html>
